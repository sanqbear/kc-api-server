# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

kc-api is a Go REST API server for Knowledge Center. It uses chi router with PostgreSQL database backend.

## Common Commands

```bash
make build      # Build the application (outputs ./main)
make run        # Run the application
make test       # Run all tests
make itest      # Run integration tests (database tests with testcontainers)
make watch      # Live reload development (requires air)
make docker-run # Start PostgreSQL container
make docker-down # Stop PostgreSQL container
make clean      # Remove built binary
make all        # Build and test
make swag       # Generate Swagger documentation
```

## Architecture

```
cmd/api/main.go          # Entry point with graceful shutdown handling, [DI Root] This is where all dependencies are assembled.
internal/
  server/
    server.go            # HTTP server setup, reads PORT from env, DI configuration
    routes.go            # Chi router with middleware (Logger, CORS, Swagger)
  database/
    database.go          # PostgreSQL connection via pgx, singleton pattern
  users/                 # User domain
    model.go             # User data structures and DTOs
    repository.go        # User database operations
    service.go           # User business logic
    handler.go           # User HTTP handlers
    handler_test.go      # User handler tests
  auth/                  # Authentication domain
    model.go             # Auth request/response structures
    repository.go        # Token and group database operations
    service.go           # Authentication business logic (JWT, password hashing)
    handler.go           # Auth HTTP handlers (login, register, refresh, logout)
    middleware.go        # JWT authentication middleware
    handler_test.go      # Auth handler tests
docs/
  docs.go                # Generated Swagger docs (auto-generated by swag)
  swagger.json           # OpenAPI 2.0 spec in JSON
  swagger.yaml           # OpenAPI 2.0 spec in YAML
  SWAG_GUIDELINES.md     # API comment guidelines for swag library
wiki/
  users.md               # User domain documentation
  auth.md                # Authentication domain documentation
```

**Key patterns:**
- Database uses singleton pattern (`dbInstance`) to reuse connections
- Environment variables loaded via godotenv/autoload
- HTTP server configured with timeouts (read: 10s, write: 30s, idle: 1m)
- Integration tests use testcontainers-go for PostgreSQL
- It is a structure that uses the Domain-Driven Design style and complies with Dependency Injection (DI), and all dependencies must be injected in cmd/api/main.go
- Every domain handler is provided with test code in a file named handler_test.go
- Swagger UI available at `/swagger/index.html` with JWT Bearer authentication support
- API documentation uses swaggo/swag annotations (see `docs/SWAG_GUIDELINES.md` for comment guidelines)

## Environment Variables

Copy `.env.sample` to `.env`:
- `PORT` - HTTP server port
- `DB_HOST`, `DB_PORT`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`, `DB_SCHEMA` - PostgreSQL connection
- `ENCRYPTION_KEY` - Key for AES-256-GCM encryption (user contact information)
- `JWT_SECRET` - Secret key for signing JWT tokens

## Authentication

The API uses JWT-based authentication with access and refresh tokens:

- **Access Token**: 15-minute JWT with user ID, roles, and claims. Sent in response body.
- **Refresh Token**: 7-day random token stored in HTTP-only cookie. Implements token rotation.

Protected routes require `Authorization: Bearer <access_token>` header.

### Auth Endpoints
- `POST /auth/register` - Create new user (auto-assigns to 'public' group)
- `POST /auth/login` - Authenticate and get tokens
- `POST /auth/refresh` - Refresh tokens (uses cookie)
- `POST /auth/logout` - Revoke current token
- `GET /auth/me` - Get current user info (protected)
- `POST /auth/logout-all` - Revoke all tokens (protected)

### Role System
Roles are inherited from:
1. Direct user role assignments (`user_roles` table)
2. Group role assignments (`group_roles` table)

Token claims include deduplicated list of all user roles.
